# ごほうびポイント管理システム Webアプリ設計書

## 1. プロジェクト概要

### 1.1 目的
LINE Botと連携し、各家庭でカスタマイズ可能なポイント管理Webアプリを開発する。

### 1.2 ターゲットユーザー
- **主要ユーザー**: 年長〜小学校低学年の子どもを持つ保護者
- **利用者**: 保護者と子ども

### 1.3 コンセプト
- 紙のごほうび帳をデジタル化
- 各家庭で「何で何ポイント」を自由に設定可能
- 子どもがゲーム感覚で楽しめるゲーミフィケーション要素
- LINE Botで手軽に記録、Webアプリで設定・確認

---

## 2. システム構成

### 2.1 アーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                    Supabase                         │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐       │
│  │PostgreSQL │  │   Auth    │  │    API    │       │
│  │    DB     │  │LINE/Google│  │  自動生成  │       │
│  └───────────┘  └───────────┘  └───────────┘       │
└─────────────────────────────────────────────────────┘
         ↑                              ↑
         │                              │
┌────────┴────────┐          ┌─────────┴─────────┐
│    LINE Bot     │          │     Webアプリ      │
│    (Flask)      │          │   (Next.js)       │
│                 │          │                   │
│  ・行動記録入力  │          │  ・設定画面        │
│  ・通知         │          │  ・成果確認        │
│                 │          │  ・ゲーミフィケ     │
│  Render         │          │  Vercel           │
└─────────────────┘          └───────────────────┘
```

### 2.2 技術スタック

| レイヤー | 技術 | ホスティング |
|----------|------|--------------|
| フロントエンド | Next.js (React) | Vercel |
| バックエンド/DB | Supabase (PostgreSQL) | Supabase Cloud |
| LINE Bot | Flask（既存を改修） | Render |

### 2.3 認証方式

| ユーザー | 認証方法 |
|----------|----------|
| 保護者 | LINE / Googleログイン（選択可能） |
| 子ども | ログイン不要（ランダムURL共有） |

- 子ども用URLは推測困難なランダム文字列を使用
- 例: `https://example.com/view/abc123xyz789`

---

## 3. 機能一覧

### 3.1 役割分担

| 機能 | LINE Bot | Webアプリ |
|------|----------|-----------|
| 行動記録 | ◎（日常使い） | ○ |
| 設定変更 | × | ◎ |
| グラフ・カレンダー | × | ◎ |
| ゲーミフィケーション | △（通知のみ） | ◎ |

### 3.2 Webアプリ機能（保護者向け）

#### 設定画面
- 子どもの名前・ニックネーム登録
- 行動マスタの追加・編集・削除
- 各行動のポイント数設定
- 目標設定（自由入力式）
- 子ども用URL発行・確認

#### 成果確認画面
- ポイント推移グラフ
- カレンダー形式の行動記録表示
- 週間・月間レポート

### 3.3 Webアプリ機能（子ども向け）

#### 閲覧ページ（ログイン不要）
- 現在のポイント表示
- 目標までの進捗
- バッジ・称号の表示
- レベル・経験値の表示
- アバター・キャラクターの表示

### 3.4 ゲーミフィケーション機能

| 機能 | 説明 |
|------|------|
| バッジ・称号 | 条件達成で獲得（例：「宿題マスター」） |
| レベルアップシステム | 経験値を貯めてレベルアップ |
| アバター・キャラクター育成 | ポケモンのようにレベルで進化 |

---

## 4. データベース設計

### 4.1 ER図（概念）

```
families (家庭)
    │
    ├── children (子ども) ※1対多
    │       └── records (行動記録) ※1対多
    │
    ├── actions (行動マスタ) ※1対多
    │
    ├── goals (目標) ※1対多
    │
    └── user_families (ユーザー連携) ※1対多
            └── auth.users (Supabase認証)
```

### 4.2 テーブル定義

#### families（家庭）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| share_code | VARCHAR | 子ども用URL用ランダム文字列 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### children（子ども）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| family_id | UUID | 外部キー → families |
| name | VARCHAR | 名前 |
| nickname | VARCHAR | ニックネーム |
| total_points | INT | 累計ポイント |
| cycle_points | INT | 周回ポイント |
| level | INT | レベル（将来用） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### actions（行動マスタ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| family_id | UUID | 外部キー → families |
| name | VARCHAR | 行動名 |
| points | INT | ポイント数 |
| display_order | INT | 表示順 |
| is_active | BOOLEAN | 有効/無効 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### records（行動記録）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| child_id | UUID | 外部キー → children |
| action_id | UUID | 外部キー → actions |
| points | INT | 獲得ポイント |
| recorded_at | TIMESTAMP | 記録日時 |
| source | VARCHAR | 記録元（'line' or 'web'） |
| created_at | TIMESTAMP | 作成日時 |

#### goals（目標）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| family_id | UUID | 外部キー → families |
| title | VARCHAR | 目標タイトル |
| description | TEXT | 詳細説明 |
| target_points | INT | 必要ポイント（任意） |
| display_order | INT | 表示順 |
| is_achieved | BOOLEAN | 達成済みフラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

#### user_families（ユーザー認証連携）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| user_id | UUID | 外部キー → auth.users |
| family_id | UUID | 外部キー → families |
| role | VARCHAR | 'owner' or 'member' |
| created_at | TIMESTAMP | 作成日時 |

---

## 5. 開発フェーズ

### Phase 0: 基盤構築

| # | タスク | 内容 |
|---|--------|------|
| 0-1 | Supabaseプロジェクト作成 | アカウント作成、プロジェクト初期化 |
| 0-2 | データベース設計・構築 | テーブル作成 |
| 0-3 | Next.jsプロジェクト作成 | 初期セットアップ、Supabase接続 |
| 0-4 | 認証設定 | LINE/Googleログイン設定 |
| 0-5 | Vercelデプロイ | 初期デプロイ、環境変数設定 |

### Phase 1: MVP（設定画面）

| # | タスク | 内容 |
|---|--------|------|
| 1-1 | ログイン画面 | LINE/Google選択、ログイン処理 |
| 1-2 | 家庭の初期設定 | 初回ログイン時のセットアップフロー |
| 1-3 | 子ども登録画面 | 名前・ニックネーム入力 |
| 1-4 | 行動マスタ設定画面 | 行動名・ポイントのCRUD |
| 1-5 | 目標設定画面 | 自由入力式の目標設定 |
| 1-6 | 子ども用URL発行 | ランダム文字列のURL生成・表示 |

### Phase 2: LINE Bot連携

| # | タスク | 内容 |
|---|--------|------|
| 2-1 | LINE Bot改修 | Google Sheets → Supabase に接続変更 |
| 2-2 | 行動マスタ読み込み | Webで設定した行動・ポイントを使用 |
| 2-3 | 家庭の紐付け | LINEユーザーと家庭を紐付ける仕組み |
| 2-4 | 動作テスト | 設定変更がLINE Botに反映されることを確認 |

### Phase 3: 成果確認画面

| # | タスク | 内容 |
|---|--------|------|
| 3-1 | 子ども用閲覧ページ | URL共有でアクセスできるページ |
| 3-2 | ポイント表示 | 現在のポイント、目標までの進捗 |
| 3-3 | カレンダー表示 | 日別の行動記録を表示 |
| 3-4 | グラフ表示 | 週間・月間の推移グラフ |

### Phase 4: ゲーミフィケーション

| # | タスク | 内容 |
|---|--------|------|
| 4-1 | レベルシステム | 経験値・レベルアップの仕組み |
| 4-2 | バッジ・称号 | 条件達成で獲得する仕組み |
| 4-3 | アバター表示 | キャラクター素材の調達・実装 |
| 4-4 | 進化システム | レベルに応じた見た目変化 |

---

## 6. 設計方針

### 6.1 UI/UX
- **モバイルファースト**: スマホでの操作を最優先に設計
- **シンプルなUI**: 子どもでも直感的に理解できるデザイン

### 6.2 拡張性
- **複数の子ども対応**: DBは最初から1対多で設計、UIは後から拡張
- **マルチテナント対応**: 各家庭で独立したデータ領域

### 6.3 セキュリティ
- **子ども用URL**: 推測困難なランダム文字列を使用
- **認証**: Supabase Authによる安全な認証
- **RLS**: Row Level Securityで家庭ごとのデータ分離

---

## 7. 将来の拡張（検討中）

- 複数の子どもUI対応
- 兄弟間ランキング
- ミッション・チャレンジ機能
- 週間・月間レポートのLINE通知
- 保護者間での共有（パートナー招待）

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-24 | 初版作成（壁打ち結果をもとに作成） |
