# 要件定義書：ごほうびポイント管理Bot

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | ごほうびポイント管理Bot |
| 目的 | 子どもの行動記録とポイント管理をLINEで簡単に行う |
| 対象ユーザー | 親（主操作者）、子ども（一緒に閲覧） |
| v1スコープ | 長男1人分の管理 |

### 1.1 解決したい課題

- 紙のごほうび帳や口約束だと記録が続かない
- ポイント計算が面倒
- 親子ともに「今どれくらいがんばってるか」が分かりにくい
- 忙しい日ほど仕組みが回らないモヤモヤがある

→ LINEでサクッと記録・集計できる仕組みを実現する

---

## 2. 技術構成

| 要素 | 技術 |
|------|------|
| フレームワーク | Python + Flask |
| メッセージング | LINE Messaging API |
| データ永続化 | Google Sheets API |
| 認証方式 | サービスアカウント（JSON を環境変数で管理） |
| ホスティング | Render（Web Service） |

---

## 3. 機能一覧（v1）

| # | 機能 | 入力例 | 出力例 |
|---|------|--------|--------|
| 1 | 行動記録 | 「宿題やった」 | 「宿題を記録しました。今日は○pt、累計○pt です。」 |
| 2 | 今日のポイント確認 | 「今日のポイント」 | 「今日のポイントは○ptです。・宿題 2回 ...」 |
| 3 | ごほうび状況確認 | 「ごほうび」 | 「現在○pt。100ptまであと○pt！」 |
| 4 | ごほうび達成通知 | （自動） | 「おめでとう！100ptたまりました！」 |
| 5 | 未対応キーワード応答 | 「今日は頑張った」 | 「『宿題』『スタスタ』などの言葉を含めて送ってください。」 |

---

## 4. ユースケース

### 4.1 ユースケース1：行動を記録する

1. 「宿題」「スタスタ」などのテキストをLINEに送る
2. Botがその行動を認識し、ポイントを加算
3. Googleスプレッドシートに記録を追加
   - 日付
   - 行動名
   - ポイント
   - 登録時刻
4. Botが返信：「宿題を記録しました。今日の合計は 4pt、累計は 52pt です。」

### 4.2 ユースケース2：今日のポイントを確認する

1. 「今日のポイント」と送信
2. Botが当日の記録を集計して返信
3. 返信例：「今日のポイントは 7pt です。・宿題 3回・スタスタ 1回 …」

### 4.3 ユースケース3：累計＆ごほうび状況を確認する

1. 「ごほうび」と送信
2. Botが累計ポイントを計算し返信
3. 返信例：「現在の累計は 84pt です。100ptのごほうびまで、あと16pt！」

---

## 5. 行動認識ロジック

- 行動は「キーワードを含むかどうか」で判定
- 例：メッセージに「宿題」が含まれていれば「宿題」として認識
- 「宿題やった」「宿題おわり」なども「宿題」として扱う
- 複数のキーワードがマッチした場合は、最初にマッチしたものを採用

---

## 6. 行動マスタ（v1 コード内定数）

| 行動名 | キーワード | ポイント |
|--------|-----------|---------|
| 宿題 | 宿題 | 1 |
| スタスタ | スタスタ | 3 |
| 早寝 | 早寝 | 2 |
| お手伝い | お手伝い | 2 |

---

## 7. データ構造（スプレッドシート）

### 7.1 records シート（行動ログ）

| 列名 | 型 | 説明 |
|------|-----|------|
| date | TEXT | 日付（YYYY-MM-DD） |
| time | TEXT | 時刻（HH:MM:SS） |
| child_id | TEXT | 子どもID |
| action | TEXT | 行動名 |
| points | INTEGER | ポイント |
| memo | TEXT | メモ（空でも可） |

### 7.2 status シート（ステータス管理）

| 列名 | 型 | 説明 |
|------|-----|------|
| child_id | TEXT | 子どもID |
| total_points | INTEGER | 累計ポイント |
| cycle_points | INTEGER | 周回ポイント |

### 7.3 actions シート（行動マスタ）

| 列名 | 型 | 説明 |
|------|-----|------|
| action | TEXT | 行動名 |
| keywords | TEXT | キーワード（カンマ区切り） |
| points | INTEGER | ポイント |

※ v1 ではコード内定数を使用し、actions シートは参照しない

---

## 8. 環境変数

| 変数名 | 用途 |
|--------|------|
| LINE_CHANNEL_ACCESS_TOKEN | LINE Bot のアクセストークン |
| LINE_CHANNEL_SECRET | LINE Bot のチャネルシークレット |
| GOOGLE_SERVICE_ACCOUNT_JSON | サービスアカウント認証情報（JSON文字列） |
| SPREADSHEET_ID | 対象スプレッドシートのID |

---

## 9. ごほうびシステム

### 9.1 基本仕様

- ごほうび達成の閾値：100pt（v1 ではコード内定数）
- 「周回ポイント」と「累計ポイント」を分けて管理
- 周回ポイントが 100pt 以上になったタイミングで自動通知

### 9.2 達成時の処理

1. 周回ポイントから 100pt を引く
2. 累計ポイントはリセットせず増え続ける
3. LINEで達成通知を送信

---

## 10. エラーハンドリング

| 状況 | ユーザーへの応答 | サーバー側処理 |
|------|-----------------|---------------|
| Google Sheets API 失敗 | 「記録に失敗しました。しばらくしてからもう一度送ってください。」 | 例外をログ出力 |
| 未対応キーワード | 「『宿題』『スタスタ』『早寝』『お手伝い』などの言葉を含めて送ってください。」 | - |
| LINE API 失敗 | （返信不可） | 例外をログ出力 |

---

## 11. v1 での対象外（将来拡張）

- ポイント取り消し・修正機能
- 複数の子ども対応（child_id の切り替え）
- 複数のごほうび閾値（50pt, 100pt, 200pt など）
- actions シートからのマスタ読み込み
- Slack などへのエラー通知
- 行動記録時のメモ入力機能

---

## 12. 補足

### 12.1 子どもID について

- v1 では固定ID（`child_01`）を使用
- データ構造としては child_id カラムを持ち、将来の複数人対応に備える

### 12.2 同一行動の複数回記録

- 1日に同じ行動を複数回記録することを許可
- 各回を1行として追加し、合計ポイントで管理
